#!/bin/bash

# recon_latest - Reconstruct latest time and convert to VTK in testing directory
# Usage: ./recon_latest

set -e  # Exit on any error

# Configuration
OUTPUT_DIR="testing"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="${OUTPUT_DIR}/reconstruction_${TIMESTAMP}.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[$(date +"%H:%M:%S")]${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Check if we're in an OpenFOAM case directory
if [ ! -d "system" ] || [ ! -d "constant" ]; then
    print_error "Not in an OpenFOAM case directory! (missing system/ or constant/ directories)"
    exit 1
fi


# Check for processor directories
processor_count=$(ls -d processor* 2>/dev/null | wc -l)
if [ $processor_count -eq 0 ]; then
    print_error "No processor directories found! This script is for parallel cases."
    exit 1
fi

print_status "Found $processor_count processor directories"

# Create output directory structure
mkdir -p "$OUTPUT_DIR/vtk"
mkdir -p "$OUTPUT_DIR/logs"

# Start logging
print_status "Starting reconstruction process..."
print_status "Output directory: $OUTPUT_DIR"
print_status "Log file: $LOG_FILE"

{
    echo "OpenFOAM Reconstruction Log"
    echo "=========================="
    echo "Date: $(date)"
    echo "Case directory: $(pwd)"
    echo "Processor count: $processor_count"
    echo ""
} > "$LOG_FILE"

# Step 1: Reconstruct latest time
print_status "Step 1: Reconstructing latest time..."
if reconstructPar -latestTime >> "$LOG_FILE" 2>&1; then
    print_success "Reconstruction completed successfully"
    echo "Reconstruction: SUCCESS" >> "$LOG_FILE"
else
    print_error "Reconstruction failed! Check log: $LOG_FILE"
    echo "Reconstruction: FAILED" >> "$LOG_FILE"
    exit 1
fi

# Step 2: Convert to VTK
print_status "Step 2: Converting to VTK format..."
if foamToVTK -latestTime >> "$LOG_FILE" 2>&1; then
    print_success "VTK conversion completed successfully"
    echo "VTK conversion: SUCCESS" >> "$LOG_FILE"
else
    print_error "VTK conversion failed! Check log: $LOG_FILE"
    echo "VTK conversion: FAILED" >> "$LOG_FILE"
    exit 1
fi

# Step 3: Move VTK files to testing directory
print_status "Step 3: Moving VTK files to $OUTPUT_DIR/vtk/..."
if [ -d "VTK" ]; then
    # Copy VTK files
    cp -r VTK/* "$OUTPUT_DIR/vtk/" 2>/dev/null || {
        print_warning "No VTK files to copy, but VTK directory exists"
    }
    
    # Get the latest time directory name for organization
    latest_time=$(ls VTK/ | grep -E '^[0-9]' | sort -n | tail -1 2>/dev/null || echo "unknown")
    
    if [ "$latest_time" != "unknown" ]; then
        print_success "VTK files for time $latest_time copied to $OUTPUT_DIR/vtk/"
        echo "Latest time processed: $latest_time" >> "$LOG_FILE"
        
        # Also copy to a time-specific subdirectory
        mkdir -p "$OUTPUT_DIR/vtk_time_$latest_time"
        cp -r VTK/* "$OUTPUT_DIR/vtk_time_$latest_time/" 2>/dev/null
        print_success "Also saved in $OUTPUT_DIR/vtk_time_$latest_time/"
    else
        print_success "VTK files copied to $OUTPUT_DIR/vtk/"
    fi
    
    # Clean up original VTK directory
    rm -rf VTK
    print_success "Original VTK directory cleaned up"
    
else
    print_warning "No VTK directory found - this is unusual"
fi

# Step 4: Clean up reconstructed field files (since simulation will do this automatically)
print_status "Step 4: Cleaning up temporary reconstructed fields..."
latest_time_dir=$(ls -d [0-9]* 2>/dev/null | sort -n | tail -1 2>/dev/null || echo "")

if [ -n "$latest_time_dir" ] && [ "$latest_time_dir" != "0" ]; then
    # Only remove if it's not the initial time directory
    print_status "Removing temporary reconstructed time directory: $latest_time_dir"
    rm -rf "$latest_time_dir"
    print_success "Temporary reconstructed fields cleaned up (simulation will recreate these when finished)"
    echo "Reconstructed fields cleaned up: $latest_time_dir" >> "$LOG_FILE"
else
    print_warning "No reconstructed time directories found to clean up"
fi

# Step 5: Create summary
{
    echo ""
    echo "Summary"
    echo "======="
    echo "Processing completed: $(date)"
    echo "Total processing time: $SECONDS seconds"
    echo ""
    echo "Output structure:"
    echo "- VTK files: $OUTPUT_DIR/vtk/"
    if [ -n "$latest_time" ] && [ "$latest_time" != "unknown" ]; then
        echo "- Time-specific VTK: $OUTPUT_DIR/vtk_time_$latest_time/"
    fi
    echo "- This log: $LOG_FILE"
    echo ""
    echo "Note: Temporary reconstructed fields were cleaned up."
    echo "      The simulation will reconstruct everything when complete."
} >> "$LOG_FILE"

# Final status
echo ""
print_success "All processing completed successfully!"
print_status "Results saved in: $OUTPUT_DIR/"
print_status "Processing time: ${SECONDS}s"

# Show directory contents
echo ""
print_status "Output directory contents:"
ls -la "$OUTPUT_DIR/"

echo ""
print_status "To view VTK files in ParaView:"
echo "  paraview $OUTPUT_DIR/vtk/"
